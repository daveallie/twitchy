{"version":3,"sources":["../scripts.babel/background.js"],"names":[],"mappings":"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","file":"background.js","sourcesContent":["'use strict';\n\nvar channels = [],// { url: 'sips_', display: null, streaming: false, data: null }],\n                // { url: 'riotgames', display: null, streaming: false, data: null },\n                // { url: 'crendor', display: null, streaming: false, data: null }],\n    lastLoaded = 0;\n\nfunction findChannelIndex(url) {\n  for (var i = 0, len = channels.length; i < len; i++) {\n    if (channels[i].url === url) {\n      return i;\n    }\n  }\n  return null;\n}\n\nfunction streamData() {\n  return $.ajax({\n    url: 'https://api.twitch.tv/kraken/streams',\n    dataType: 'json',\n    data: { channel: $.map(channels, function (channel) {\n        return channel.url;\n      }), limit: 100 }\n  });\n}\n\nfunction getSingleChannelInfo(url) {\n  return $.ajax({\n    url: 'https://api.twitch.tv/kraken/channels/' + url,\n    dataType: 'json'\n  });\n}\n\nfunction channelInfo() {\n  return new Promise(function (resolve, reject) {\n    var urlsToFetch = $.grep($.map(channels, function (channel) {\n      if (channel.display === null) {\n        return channel.url;\n      }\n    }), function (n) {\n      return n;\n    });\n\n    if (urlsToFetch.length > 0) {\n      $.when.apply($, $.map(urlsToFetch, function (url) {\n        return getSingleChannelInfo(url);\n      })).then(function () {\n        var broken = false,\n            responses = [];\n\n        if (urlsToFetch.length === 1) {\n          responses.push(arguments);\n        } else {\n          responses = arguments;\n        }\n\n        for (var i = 0, len = responses.length; i < len; i++) {\n          if (responses[i][1] === 'success') {\n            channels[findChannelIndex(responses[i][0].name)].display = responses[i][0].display_name;\n          } else {\n            reject();\n            broken = true;\n            break;\n          }\n        }\n\n        if (!broken) {\n          resolve();\n        }\n      }, function () {\n        console.error('failed');\n        reject();\n      });\n    } else {\n      resolve();\n    }\n  });\n}\n\nfunction resetStreamData() {\n  for (var i = 0, len = channels.length; i < len; i++) {\n    channels[i].streaming = false;\n    channels[i].data = null;\n  }\n}\n\nfunction reloadAll(callback) {\n  $.when(streamData(), channelInfo()).then(function (streamDataResponse, _) {\n    resetStreamData();\n    var total = 0;\n    $.each(streamDataResponse[0].streams, function (_, stream) {\n      var i = findChannelIndex(stream.channel.name);\n      if (i !== null) {\n        channels[i].streaming = true;\n        channels[i].data = stream;\n        total += 1;\n      }\n    });\n\n    if (total === 0) {\n      chrome.browserAction.setBadgeText({ text: '' });\n    } else {\n      chrome.browserAction.setBadgeText({ text: total.toString() });\n    }\n\n    lastLoaded = Math.floor(new Date().getTime() / 1000);\n    callback && callback({ channels: channels, success: true, reloaded: true });\n  }, function () {\n    console.error('fail');\n    callback && callback({ channels: channels, success: false, reloaded: false });\n  });\n}\n\nfunction sendMessage(port, message) {\n  port.postMessage(message);\n}\n\nchrome.runtime.onInstalled.addListener(function (details) {\n  chrome.alarms.create('update', {periodInMinutes: 5});\n  chrome.storage.local.set({urls: []});\n\n  chrome.runtime.onConnect.addListener(function (port) {\n    if (port.name === 'channel_data') {\n      port.onMessage.addListener(function (request) {\n        if (request.force === true || Math.floor(new Date().getTime() / 1000) - lastLoaded > 1) {\n          reloadAll(sendMessage.bind(this, port));\n        } else {\n          port.postMessage({ channels: channels, success: true, reloaded: false });\n        }\n      });\n    }\n\n\n\n    else if (port.name === 'options') {\n      port.onMessage.addListener(function (request) {\n        if (request.action === 'add') {\n          var urls = $.map(channels, function(channel) {return channel.url}),\n              toAdd = [],\n              res = [];\n          $.each(request.urls, function(_, url) {\n            if ($.inArray(url, urls) === -1) {\n              res.push({url: url, status: 'failed'});\n              toAdd.push(url);\n              //channels.push({url: url, display: null, streaming: false, data: null});\n              // urls.push(url);\n            } else {\n              res.push({url: url, status: 'exists'});\n            }\n          });\n\n          $.when.apply($, $.map(toAdd, function (url) {\n            return getSingleChannelInfo(url);\n          })).then(function () {\n            var responses = [];\n\n            if (toAdd.length === 1) {\n              responses.push(arguments);\n            } else {\n              responses = arguments;\n            }\n\n            for (var i = 0, len = responses.length; i < len; i++) {\n              if (responses[i][1] === 'success' && responses[i][0].status !== 422) {\n                channels.push({url: responses[i][0].name, display: responses[i][0].display_name, streaming: false, data: null});\n                for (var j = 0, len = res.length; j < len; j++) {\n                  if (res[j].url === responses[i][0].name) {\n                    res[j].status = 'success';\n                    break;\n                  }\n                }\n                urls.push(responses[i][0].name);\n              }\n            }\n\n            port.postMessage(res);\n            reloadAll(false);\n            chrome.storage.local.set({urls: urls});\n          }, function () {\n            console.error('failed');\n            port.postMessage(res);\n          });\n        } else if (request.action === 'delete') {\n          var urls = [];\n          channels = $.grep($.map(channels, function (channel) {\n            if ($.inArray(channel.url, request.urls) === -1) {\n              urls.push(channel.url);\n              return channel;\n            }\n          }), function (n) {\n            return n;\n          });\n\n          port.postMessage('OK');\n          chrome.storage.local.set({urls: urls});\n        }\n      });\n    }\n  });\n\n  chrome.alarms.onAlarm.addListener(function(alarm) {\n    reloadAll(false);\n  });\n\n  reloadAll(false);\n});\n\n\nchrome.storage.local.get('urls', function(response) {\n  channels = $.map(response.urls, function(url) {\n    return {url: url, display: null, streaming: false, data: null};\n  });\n});\n"]}